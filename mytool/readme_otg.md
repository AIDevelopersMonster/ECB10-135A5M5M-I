# USB OTG — тестирование и проверка

Этот документ описывает **как проверяется USB OTG порт** на плате и **какие команды Linux полезны для ручной диагностики**.

Тест ориентирован на реальное поведение системы и учитывает, что:
- автоматического переключения OTG ролей нет
- режим OTG задаётся в **device tree (`dr_mode`)**
- OTG и обычный USB HOST (через HUB) — это разные контроллеры

---

## 1. Что такое USB OTG на этой плате

На плате используется контроллер **DWC2 (USB OTG)**:

- Контроллер: `dwc2`
- Назначение: USB OTG (Type-C)
- Роль: **фиксированная**, задаётся в device tree

Возможные режимы:

- `dr_mode = "host"` — OTG работает как USB HOST
- `dr_mode = "peripheral"` — OTG работает как USB DEVICE (gadget)

⚠️ Автоматического переключения ролей **нет**.

---

## 2. Как работает OTG тест в проекте

OTG тест выполняется в отдельной вкладке и **автоматически определяет текущее состояние прошивки**.

Тест **НЕ переключает роли** и **НЕ меняет device tree**.

### Что делает тест:

1. Проверяет наличие OTG контроллера (DWC2) в `dmesg`
2. Проверяет, активен ли OTG HOST (по событиям `using dwc2`)
3. Проверяет наличие USB Mass Storage (`/dev/sdX1`)
4. Проверяет файловую систему (ожидается FAT32)
5. При активном OTG HOST выполняет R/W тест

---

## 3. OTG HOST — сценарий тестирования

### Условия

- OTG порт переведён в `dr_mode = "host"`
- Используется **Type-C OTG адаптер (host adapter)**
- Устройство: SD-карта через USB кардридер
- Файловая система: FAT32

---

### Алгоритм теста (OTG HOST)

1. Подключить OTG адаптер в Type-C
2. Вставить SD-кардридер
3. Нажать **Detect OTG**
4. При обнаружении устройства — нажать **Run OTG R/W test**

Тест выполняет:

- монтирование устройства
- запись тестового файла
- чтение и сравнение данных
- корректное размонтирование

При успехе выводится:

```
RESULT: PASS (OTG HOST R/W)
```

---

## 4. Что означает PASS / WARN

| Статус | Значение |
|------|---------|
| PASS | OTG HOST активен, R/W тест пройден |
| WARN | OTG обнаружен, но роль или ФС не подходят |
| SKIP | OTG отключён прошивкой |
| FAIL | Ошибка монтирования / записи / чтения |

---

## 5. Почему `/sys/class/udc` может быть пустым

`/sys/class/udc` используется **только в OTG peripheral (device) режиме**.

Если OTG работает как HOST:

- `/sys/class/udc` будет пуст
- это **нормально**

---

## 6. Типовые ошибки и их причины

### `FAT-fs: Volume was not properly unmounted`

Причина:
- накопитель был физически отключён без `umount`

Решение:
```sh
sync
umount /mnt/otg
sync
```

---

### `device offline error` / `Buffer I/O error`

Причина:
- отключение USB устройства во время записи

Решение:
- всегда выполнять `sync`
- не вытаскивать устройство до завершения теста

---

## 7. Полезные CLI команды для проверки OTG

### Проверка OTG контроллера

```sh
dmesg | grep -i dwc2
```

Ожидается:
```
dwc2 ... DWC OTG Controller
```

---

### Проверка активности OTG HOST

```sh
dmesg | grep -E "usb 1-.* using dwc2"
```

---

### Проверка USB устройств

```sh
lsusb
```

---

### Проверка блочных устройств

```sh
ls /dev/sd* 2>/dev/null
cat /proc/partitions | tail
```

---

### Определение файловой системы

```sh
file -s /dev/sda1
```

---

### Ручной R/W тест (OTG HOST)

```sh
mkdir -p /mnt/otg
mount -t vfat /dev/sda1 /mnt/otg
echo "OTG HOST OK" > /mnt/otg/test.txt
sync
cat /mnt/otg/test.txt
sync
umount /mnt/otg
sync
```

---

## 8. Итог

- OTG HOST на плате **работает корректно**
- Контроллер DWC2 успешно поднимает USB Mass Storage
- GUI тест повторяет реальный CLI сценарий
- Тест безопасен и подходит для bring-up и демонстраций

OTG peripheral (gadget) режим является **отдельным сценарием** и не включён в данный тест.

